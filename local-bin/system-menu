#!/bin/bash
# Hierarchical system menu for Hyprland

# Parse location parameter (default: center)
LOCATION="${1:---location center}"
if [[ "$1" == "--location" ]]; then
    LOCATION="--location $2"
fi

# Check if menu is already running using hyprctl
if hyprctl clients | grep -q "class: wofi"; then
    # Menu already open, exit
    exit 0
fi

# Function to build wofi positioning parameters
get_wofi_positioning() {
    if [[ "$LOCATION" == *"top_left"* ]]; then
        # Use explicit pixel positioning: 8px from left, 8px from top
        echo "-x 8 -y 8 --width 200 --height 360"
    else
        # Use default location (center)
        echo "$LOCATION"
    fi
}

# Function to show main menu
show_main_menu() {
    echo -e "ðŸƒ Run\nðŸš€ Applications\nðŸ“¸ Screenshots\nðŸ”Š Audio\nðŸ–¥ï¸ Display\nðŸŒ Network\nâ„¹ï¸ System Info\nâ˜• Caffeine\nðŸ”´ Power"
}

# Function to show power submenu
show_power_menu() {
    echo -e "â¬…ï¸ Back\nðŸ”’ Lock\nðŸ”´ Shutdown\nðŸ”ƒ Reboot\nðŸ˜´ Suspend\nðŸšª Logout"
}

# Function to show screenshot submenu
show_screenshot_menu() {
    echo -e "â¬…ï¸ Back\nðŸ“¸ Full Screenshot\nðŸ”² Region Screenshot\nðŸŽ¥ Start Recording\nâ¹ï¸ Stop Recording"
}

# Function to show audio submenu
show_audio_menu() {
    echo -e "â¬…ï¸ Back\nðŸ”Š Volume Up\nðŸ”‡ Volume Down\nðŸ”• Toggle Mute\nðŸŽ¤ Toggle Mic Mute"
}

# Function to show display submenu
show_display_menu() {
    echo -e "â¬…ï¸ Back\nðŸŒ¡ï¸ Brightness Up\nâ„ï¸ Brightness Down"
}

# Function to show system info submenu
show_system_info_menu() {
    echo -e "â¬…ï¸ Back\nðŸ“Š System Stats\nðŸŒ IP Address\nâ±ï¸ Uptime"
}

# Function to show network submenu
show_network_menu() {
    echo -e "â¬…ï¸ Back\nðŸ“¡ Toggle WiFi\nðŸ”µ Toggle Bluetooth"
}

# Function to show caffeine submenu
show_caffeine_menu() {
    echo -e "â¬…ï¸ Back\nâ˜• Caffeinate\nðŸ˜´ Decaffeinate"
}

# Function to execute power commands
execute_power() {
    case "$1" in
        *"Lock")
            hyprlock
            ;;
        *"Shutdown")
            systemctl poweroff
            ;;
        *"Reboot")
            systemctl reboot
            ;;
        *"Suspend")
            systemctl suspend
            ;;
        *"Logout")
            hyprctl dispatch exit
            ;;
    esac
}

# Function to execute screenshot commands
execute_screenshot() {
    case "$1" in
        *"Full")
            ~/.local/bin/screenshot
            ;;
        *"Region")
            ~/.local/bin/screenshot region
            ;;
        *"Start")
            notify-send "ðŸŽ¥ Recording started"
            wf-recorder --audio=pulse --audio-source=@DEFAULT_SINK@ -f ~/Videos/rec_$(date +"%Y-%m-%d_%H-%M-%S").mp4 &
            ;;
        *"Stop")
            pkill -SIGINT wf-recorder
            notify-send "âœ… Recording stopped"
            ;;
    esac
}

# Function to execute audio commands
execute_audio() {
    case "$1" in
        *"Volume Up")
            wpctl set-volume -l 1 @DEFAULT_AUDIO_SINK@ 5%+
            ;;
        *"Volume Down")
            wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
            ;;
        *"Toggle Mute")
            wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
            ;;
        *"Toggle Mic")
            wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle
            ;;
    esac
}

# Function to execute display commands
execute_display() {
    case "$1" in
        *"Brightness Up")
            brightnessctl -e4 -n2 set 5%+
            ;;
        *"Brightness Down")
            brightnessctl -e4 -n2 set 5%-
            ;;
    esac
}

# Function to execute system info commands
execute_system_info() {
    case "$1" in
        *"System Stats")
            if command -v btop &>/dev/null; then
                kitty -e btop &
            else
                kitty -e htop &
            fi
            ;;
        *"IP Address")
            ip_addr=$(ip -4 addr show 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1)
            notify-send "IP Address" "$ip_addr"
            ;;
        *"Uptime")
            uptime_info=$(uptime -p)
            notify-send "Uptime" "$uptime_info"
            ;;
    esac
}

# Function to execute network commands
execute_network() {
    case "$1" in
        *"WiFi")
            nmcli radio wifi off && notify-send "WiFi disabled" || (nmcli radio wifi on && notify-send "WiFi enabled")
            ;;
        *"Bluetooth")
            rfkill list bluetooth | grep -q "Soft blocked: yes" && rfkill unblock bluetooth && notify-send "Bluetooth enabled" || (rfkill block bluetooth && notify-send "Bluetooth disabled")
            ;;
    esac
}

# Function to execute caffeine commands
execute_caffeine() {
    case "$1" in
        *"Caffeinate")
            # Pause hypridle process (launched via Hyprland exec-once)
            pkill -STOP hypridle 2>/dev/null || notify-send "âš ï¸ Hypridle not running"
            notify-send "â˜• Caffeinated" "Screen will stay awake"
            ;;
        *"Decaffeinate")
            # Resume hypridle process
            pkill -CONT hypridle 2>/dev/null || notify-send "âš ï¸ Hypridle not running"
            notify-send "ðŸ˜´ Decaffeinated" "Screen will lock on idle"
            ;;
    esac
}

# Function to execute search commands
execute_search() {
    case "$1" in
        *"Lock") hyprlock ;;
        *"Shutdown") systemctl poweroff ;;
        *"Reboot") systemctl reboot ;;
        *"Suspend") systemctl suspend ;;
        *"Logout") hyprctl dispatch exit ;;
        *"Full Screenshot") ~/.local/bin/screenshot ;;
        *"Region Screenshot") ~/.local/bin/screenshot region ;;
        *"Start Recording") notify-send "ðŸŽ¥ Recording started"; wf-recorder --audio=pulse --audio-source=@DEFAULT_SINK@ -f ~/Videos/rec_$(date +"%Y-%m-%d_%H-%M-%S").mp4 & ;;
        *"Stop Recording") pkill -SIGINT wf-recorder; notify-send "âœ… Recording stopped" ;;
        *"Volume Up") wpctl set-volume -l 1 @DEFAULT_AUDIO_SINK@ 5%+ ;;
        *"Volume Down") wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%- ;;
        *"Toggle Mute") wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle ;;
        *"Toggle Mic") wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle ;;
        *"Brightness Up") brightnessctl -e4 -n2 set 5%+ ;;
        *"Brightness Down") brightnessctl -e4 -n2 set 5%- ;;
        *"Toggle WiFi") nmcli radio wifi off && notify-send "WiFi disabled" || (nmcli radio wifi on && notify-send "WiFi enabled") ;;
        *"Toggle Bluetooth") rfkill list bluetooth | grep -q "Soft blocked: yes" && rfkill unblock bluetooth && notify-send "Bluetooth enabled" || (rfkill block bluetooth && notify-send "Bluetooth disabled") ;;
        *"Caffeinate") pkill -STOP hypridle 2>/dev/null || true; notify-send "â˜• Caffeinated" "Screen will stay awake" ;;
        *"Decaffeinate") pkill -CONT hypridle 2>/dev/null || true; notify-send "ðŸ˜´ Decaffeinated" "Screen will lock on idle" ;;
        *"1Password") 1password & ;;
        *"Telegram") Telegram & ;;
        *"Firefox") firefox & ;;
        *"Neovim") kitty -e nvim & ;;
        *"System Stats") ( command -v btop &>/dev/null && kitty -e btop || kitty -e htop ) & ;;
        *"IP Address") ip_addr=$(ip -4 addr show 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1); notify-send "IP Address" "$ip_addr" ;;
        *"Uptime") uptime_info=$(uptime -p); notify-send "Uptime" "$uptime_info" ;;
    esac
}

# Main menu loop
current_menu="main"
while true; do
    case "$current_menu" in
        "main")
            selected=$(show_main_menu | wofi --dmenu --hide-search --prompt "System" -i $(get_wofi_positioning))
            case "$selected" in
                *"Run")
                    command=$(wofi --show run $(get_wofi_positioning))
                    if [ -z "$command" ]; then
                        current_menu="main"
                    else
                        eval "$command"
                        exit 0
                    fi
                    ;;
                *"Applications")
                    app=$(wofi --show drun $(get_wofi_positioning))
                    if [ -z "$app" ]; then
                        current_menu="main"
                    else
                        exit 0
                    fi
                    ;;
                *"Screenshots")
                    current_menu="screenshot"
                    ;;
                *"Audio")
                    current_menu="audio"
                    ;;
                *"Display")
                    current_menu="display"
                    ;;
                *"Network")
                    current_menu="network"
                    ;;
                *"System Info")
                    current_menu="sysinfo"
                    ;;
                *"Caffeine")
                    current_menu="caffeine"
                    ;;
                *"Power")
                    current_menu="power"
                    ;;
                *)
                    exit 0
                    ;;
            esac
            ;;
        "power")
            selected=$(show_power_menu | wofi --dmenu --hide-search --prompt "Power" -i $(get_wofi_positioning))
            if [[ "$selected" == *"Back"* ]] || [ -z "$selected" ]; then
                current_menu="main"
            else
                execute_power "$selected"
                exit 0
            fi
            ;;
        "screenshot")
            selected=$(show_screenshot_menu | wofi --dmenu --hide-search --prompt "Screenshots" -i $(get_wofi_positioning))
            if [[ "$selected" == *"Back"* ]] || [ -z "$selected" ]; then
                current_menu="main"
            else
                execute_screenshot "$selected"
                exit 0
            fi
            ;;
        "audio")
            selected=$(show_audio_menu | wofi --dmenu --hide-search --prompt "Audio" -i $(get_wofi_positioning))
            if [[ "$selected" == *"Back"* ]] || [ -z "$selected" ]; then
                current_menu="main"
            else
                execute_audio "$selected"
                exit 0
            fi
            ;;
        "display")
            selected=$(show_display_menu | wofi --dmenu --hide-search --prompt "Display" -i $(get_wofi_positioning))
            if [[ "$selected" == *"Back"* ]] || [ -z "$selected" ]; then
                current_menu="main"
            else
                execute_display "$selected"
                exit 0
            fi
            ;;
        "sysinfo")
            selected=$(show_system_info_menu | wofi --dmenu --hide-search --prompt "System Info" -i $(get_wofi_positioning))
            if [[ "$selected" == *"Back"* ]] || [ -z "$selected" ]; then
                current_menu="main"
            else
                execute_system_info "$selected"
                exit 0
            fi
            ;;
        "network")
            selected=$(show_network_menu | wofi --dmenu --hide-search --prompt "Network" -i $(get_wofi_positioning))
            if [[ "$selected" == *"Back"* ]] || [ -z "$selected" ]; then
                current_menu="main"
            else
                execute_network "$selected"
                exit 0
            fi
            ;;
        "caffeine")
            selected=$(show_caffeine_menu | wofi --dmenu --hide-search --prompt "Caffeine" -i $(get_wofi_positioning))
            if [[ "$selected" == *"Back"* ]] || [ -z "$selected" ]; then
                current_menu="main"
            else
                execute_caffeine "$selected"
                exit 0
            fi
            ;;
        *)
            exit 0
            ;;
    esac
done
