#!/bin/bash
# Display Switcher for Hyprland + hmonitor
# Provides wofi menu for switching between hmonitor profiles
# Usage: display-switch [profile_name]

set -euo pipefail

# Color output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

log_msg() {
    local msg="$1"
    echo -e "${BLUE}[display-switch]${NC} $msg" >&2
}

success_msg() {
    local msg="$1"
    echo -e "${GREEN}[display-switch]${NC} $msg" >&2
}

error_msg() {
    local msg="$1"
    echo -e "${RED}[display-switch]${NC} $msg" >&2
}

# Switch to a profile
switch_profile() {
    local profile="$1"
    log_msg "Switching to profile: $profile"

    if hmonitor profile switch "$profile" 2>/dev/null; then
        success_msg "Switched to profile: $profile"
        notify-send -u normal "Display" "ðŸ“º Switched to profile: $profile" 2>/dev/null || true
        return 0
    else
        error_msg "Failed to switch to profile: $profile"
        notify-send -u critical "Display" "âš ï¸ Failed to switch to profile: $profile" 2>/dev/null || true
        return 1
    fi
}

# Show wofi menu for profile switching
show_menu() {
    # Get list of available profiles
    local profiles=$(hmonitor profile list 2>/dev/null | grep -E '^\s+' | awk '{print $1}' || echo "")

    if [ -z "$profiles" ]; then
        error_msg "No profiles found. Run 'hmonitor wizard' to create profiles."
        notify-send -u critical "Display" "âš ï¸ No profiles configured. Run 'hmonitor wizard'" 2>/dev/null || true
        return 1
    fi

    # Show wofi menu with profiles
    local selection=$(echo "$profiles" | wofi --dmenu -p "Display Profile" 2>/dev/null)

    if [ -n "$selection" ]; then
        switch_profile "$selection"
    else
        log_msg "No profile selected"
        return 1
    fi
}

# Main logic
if [ -z "${1:-}" ]; then
    # No argument: show wofi menu
    show_menu
else
    # Argument provided: switch directly
    switch_profile "$1"
fi
