#!/bin/bash
# Display Switcher for Hyprland
# Provides wofi menu for switching between different display configurations
# Usage: display-switch [config_name]
# Supported configs: laptop, laptop-external, external, mirror

set -euo pipefail

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration: Define your monitor names here
# Run 'hyprctl monitors -j' to discover monitor names
EXTERNAL_MONITOR="${EXTERNAL_MONITOR:-DP-2}"      # Primary external display
INTERNAL_MONITOR="${INTERNAL_MONITOR:-eDP-1}"     # Laptop internal display
EXTERNAL_REFRESH="${EXTERNAL_REFRESH:-highrr}"    # External display refresh rate

log_msg() {
    local msg="$1"
    echo -e "${BLUE}[display-switch]${NC} $msg" >&2
}

error_msg() {
    local msg="$1"
    echo -e "${RED}[display-switch]${NC} $msg" >&2
}

success_msg() {
    local msg="$1"
    echo -e "${GREEN}[display-switch]${NC} $msg" >&2
}

notify() {
    local title="$1"
    local msg="$2"
    notify-send -u normal "$title" "$msg" 2>/dev/null || true
}

# Get list of connected monitors
get_connected_monitors() {
    hyprctl monitors -j 2>/dev/null | jq -r '.[].name' 2>/dev/null || echo ""
}

# Check if a monitor is connected
is_monitor_connected() {
    local monitor="$1"
    get_connected_monitors | grep -q "^${monitor}$"
}

# Apply monitor configuration
apply_config() {
    local config="$1"

    case "$config" in
        laptop)
            log_msg "Switching to laptop-only mode..."
            if is_monitor_connected "$EXTERNAL_MONITOR"; then
                hyprctl keyword monitor "$EXTERNAL_MONITOR,disable" 2>/dev/null || true
            fi
            if is_monitor_connected "$INTERNAL_MONITOR"; then
                hyprctl keyword monitor "$INTERNAL_MONITOR,preferred,auto,1" 2>/dev/null || true
            fi
            success_msg "Switched to laptop display"
            notify "Display" "ðŸ’» Switched to Laptop Only"
            ;;

        laptop-external)
            log_msg "Switching to laptop + external mode..."
            if is_monitor_connected "$EXTERNAL_MONITOR"; then
                hyprctl keyword monitor "$EXTERNAL_MONITOR,$EXTERNAL_REFRESH,auto,1" 2>/dev/null || true
            fi
            if is_monitor_connected "$INTERNAL_MONITOR"; then
                hyprctl keyword monitor "$INTERNAL_MONITOR,preferred,auto,1" 2>/dev/null || true
            fi
            success_msg "Switched to laptop + external display"
            notify "Display" "ðŸ–¥ï¸ Switched to Laptop + External"
            ;;

        external)
            log_msg "Switching to external-only mode..."
            if is_monitor_connected "$EXTERNAL_MONITOR"; then
                hyprctl keyword monitor "$EXTERNAL_MONITOR,$EXTERNAL_REFRESH,auto,1" 2>/dev/null || true
                if is_monitor_connected "$INTERNAL_MONITOR"; then
                    hyprctl keyword monitor "$INTERNAL_MONITOR,disable" 2>/dev/null || true
                fi
                success_msg "Switched to external display"
                notify "Display" "ðŸ–¥ï¸ Switched to External Only"
            else
                error_msg "External monitor not connected"
                notify "Display" "âš ï¸ External monitor not connected"
                return 1
            fi
            ;;

        mirror)
            log_msg "Switching to mirror mode..."
            if is_monitor_connected "$EXTERNAL_MONITOR" && is_monitor_connected "$INTERNAL_MONITOR"; then
                # Mirror by positioning external at same location as internal
                hyprctl keyword monitor "$EXTERNAL_MONITOR,$EXTERNAL_REFRESH,0x0,1" 2>/dev/null || true
                hyprctl keyword monitor "$INTERNAL_MONITOR,preferred,0x0,1" 2>/dev/null || true
                success_msg "Switched to mirror mode"
                notify "Display" "ðŸ”„ Switched to Mirror Mode"
            else
                error_msg "Both monitors required for mirror mode"
                notify "Display" "âš ï¸ Both monitors required for mirror mode"
                return 1
            fi
            ;;

        *)
            error_msg "Unknown configuration: $config"
            return 1
            ;;
    esac
}

# Show wofi menu for display switching
show_menu() {
    local options=()

    # Always available
    options+=("ðŸ’»  Laptop Only")

    # Only show if external is connected
    if is_monitor_connected "$EXTERNAL_MONITOR"; then
        options+=("ðŸ–¥ï¸  Laptop + External")
        options+=("ðŸ–¥ï¸  External Only")
    fi

    # Only show mirror if both are connected
    if is_monitor_connected "$EXTERNAL_MONITOR" && is_monitor_connected "$INTERNAL_MONITOR"; then
        options+=("ðŸ”„  Mirror")
    fi

    # Show wofi menu
    local selection=$(printf '%s\n' "${options[@]}" | wofi --dmenu -p "Display Mode" 2>/dev/null)

    case "$selection" in
        *"Laptop Only")
            apply_config "laptop"
            ;;
        *"Laptop + External")
            apply_config "laptop-external"
            ;;
        *"External Only")
            apply_config "external"
            ;;
        *"Mirror")
            apply_config "mirror"
            ;;
        *)
            log_msg "No selection made"
            return 1
            ;;
    esac
}

# Main logic
if [ -z "${1:-}" ]; then
    # No argument: show wofi menu
    show_menu
else
    # Argument provided: apply directly
    apply_config "$1"
fi
